# üîß ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
def compute_summary(df):
    total_prb = round(df["‡∏û‡∏£‡∏ö."].sum(), 4)
    total_after = round(df["‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô"].sum(), 4)
    total_disb = round(df["‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢"].sum(), 4)
    total_spend = round(df["‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"].sum(), 4)
    percent_disb = round((total_disb / total_after) * 100, 2) if total_after else 0
    percent_spend = round((total_spend / total_after) * 100, 2) if total_after else 0
    return total_prb, total_after, total_disb, percent_disb, total_spend, percent_spend

# üîß ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• metric ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏µ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°
def show_metrics(data, title):
    prb, after, disb, per_disb, spend, per_spend = data
    st.markdown(f"### {title}")
    col1, col2, col3 = st.columns(3)

    # ‚úÖ ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°
    if title == "üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°":
        disb_threshold = 87.67
        spend_threshold = 93.33
    elif title == "üè¢ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥":
        disb_threshold = 92
        spend_threshold = 93.67
    elif title == "üèóÔ∏è ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô":
        disb_threshold = 71.33
        spend_threshold = 92.33
    else:
        disb_threshold = spend_threshold = 0

    def small_metric(label, value, is_percent=False, threshold=None):
        formatted = f"{value:,.2f}%" if is_percent else f"{value:,.4f}"
        color = (
            "#00FF9F" if is_percent and value >= threshold
            else "#FF4B4B" if is_percent
            else "inherit"
        )
        return f"""
            <div style='margin-bottom: 0.75rem;'>
                <div class='metric-label'>{label}</div>
                <div class='metric-value' style='color: {color};'>{formatted}</div>
            </div>
        """

    with col1:
        st.markdown(small_metric("‡∏û.‡∏£.‡∏ö.", prb), unsafe_allow_html=True)
        st.markdown(small_metric("‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô", after), unsafe_allow_html=True)
    with col2:
        st.markdown(small_metric("‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢", disb), unsafe_allow_html=True)
        st.markdown(small_metric("%‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢", per_disb, is_percent=True, threshold=disb_threshold), unsafe_allow_html=True)
    with col3:
        st.markdown(small_metric("‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", spend), unsafe_allow_html=True)
        st.markdown(small_metric("%‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", per_spend, is_percent=True, threshold=spend_threshold), unsafe_allow_html=True)

#-----*********************************************************
#-----*********************************************************
# ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏°‡∏ô‡∏π
if "1Ô∏è‚É£ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®" in selected_menus:
    st.markdown("## 1Ô∏è‚É£‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®")

    # ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
    total_all = compute_summary(df)
    total_regular = compute_summary(df[df['‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥/‡∏•‡∏á‡∏ó‡∏∏‡∏ô'] == "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥"])
    total_invest = compute_summary(df[df['‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥/‡∏•‡∏á‡∏ó‡∏∏‡∏ô'] == "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô"])

    # ‡πÅ‡∏™‡∏î‡∏á Metric
    show_metrics(total_all, "üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°")
    show_metrics(total_regular, "üè¢ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥")
    show_metrics(total_invest, "üèóÔ∏è ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô")
    st.markdown("<br>", unsafe_allow_html=True)

#--------------------------------------------------------------

# üîß ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå
def prepare_table(df_part, category="‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°"):
    df_part = df_part.groupby("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô")[["‡∏û‡∏£‡∏ö.", "‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô", "‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢", "‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"]].sum().reset_index()
    df_part["%‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢"] = (df_part["‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢"] / df_part["‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô"]) * 100
    df_part["%‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"] = (df_part["‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"] / df_part["‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô"]) * 100
    cols = ["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô", "‡∏û‡∏£‡∏ö.", "‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô", "‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢", "%‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢", "‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", "%‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"]
    df_part = df_part[cols]

    def highlight(row):
        color_disb = get_color(row["%‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢"], category, "‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢")
        color_spend = get_color(row["%‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"], category, "‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢")
        return ["", "", "", "", f"color: {color_disb}", "", f"color: {color_spend}"]

    styled_df = df_part.style.format({
        "‡∏û‡∏£‡∏ö.": "{:,.4f}",
        "‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô": "{:,.4f}",
        "‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢": "{:,.4f}",
        "‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢": "{:,.4f}",
        "%‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢": "{:,.2f}%",
        "%‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢": "{:,.2f}%"
    }).apply(highlight, axis=1)

    return styled_df


# üîß ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏° DataFrame
def compute_summary(df):
    total_prb = df["‡∏û‡∏£‡∏ö."].sum()
    total_after = df["‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô"].sum()
    total_disb = df["‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢"].sum()
    total_spend = df["‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"].sum()
    percent_disb = round((total_disb / total_after) * 100, 2) if total_after else 0
    percent_spend = round((total_spend / total_after) * 100, 2) if total_after else 0
    return total_prb, total_after, total_disb, percent_disb, total_spend, percent_spend

#---------------------------------------------------------------------------
# üîß ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
def get_color(value, category, target_type):
    """
    category: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°', '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥', '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô'
    target_type: '‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢' ‡∏´‡∏£‡∏∑‡∏≠ '‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢'
    """
    thresholds = {
        "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°": {"‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢": 87.67, "‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢": 93.33},
        "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥": {"‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢": 92, "‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢": 93.67},
        "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô": {"‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢": 71.33, "‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢": 92.33},
    }
    threshold = thresholds.get(category, {}).get(target_type, 0)
    return "#00FF9F" if value >= threshold else "#FF4B4B"
 
# üîπ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á
def show_ministry_table(df_subset, title, category):
    if df_subset.empty:
        st.info(f"‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö {title}")
        return

    df_grouped = df_subset.groupby("‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á", as_index=False)[
        ["‡∏û‡∏£‡∏ö.", "‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô", "‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢", "‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"]
    ].sum(numeric_only=True)

    df_grouped["%‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢"] = round((df_grouped["‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢"] / df_grouped["‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô"]) * 100, 2)
    df_grouped["%‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"] = round((df_grouped["‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"] / df_grouped["‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô"]) * 100, 2)

    display_cols = ["‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á", "‡∏û‡∏£‡∏ö.", "‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô", "‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢", "%‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢", "‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", "%‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"]

    # ‚úÖ ‡πÉ‡∏™‡πà‡∏™‡∏µ‡∏ï‡∏≤‡∏° threshold
    def highlight(row):
        c1 = get_color(row["%‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢"], category, "‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢")
        c2 = get_color(row["%‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"], category, "‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢")
        return ["", "", "", "", f"color:{c1}", "", f"color:{c2}"]

    styled = df_grouped[display_cols].style.format({
        "‡∏û‡∏£‡∏ö.": "{:,.4f}",
        "‡∏á‡∏ö‡∏Ø ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô": "{:,.4f}",
        "‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢": "{:,.4f}",
        "‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢": "{:,.4f}",
        "%‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢": "{:,.2f}%",
        "%‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢": "{:,.2f}%"
    }).apply(highlight, axis=1)

    st.markdown(f"### {title}")
    st.dataframe(styled, use_container_width=True)


# --------------------------------------------------------------
st.markdown("## üîµ ‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á/‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á")
# üî∏ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á
show_ministry_table(df, "üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°", "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°")

# üî∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (‡∏£‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á)
df_regular = df[df["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥/‡∏•‡∏á‡∏ó‡∏∏‡∏ô"] == "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥"]
show_ministry_table(df_regular, "üè¢ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥", "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥")

# üî∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô (‡∏£‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á)
df_invest = df[df["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥/‡∏•‡∏á‡∏ó‡∏∏‡∏ô"] == "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô"]
show_ministry_table(df_invest, "üèóÔ∏è ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô", "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô")
